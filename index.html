<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Path Manuscript Journeys</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://unpkg.com/topojson-client@3"></script>
    <style>
@import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600&family=Cinzel+Decorative:wght@400;700&display=swap');

body {
    margin: 0;
    padding: 20px;
    font-family: 'Cinzel', 'Trajan Pro', 'Times New Roman', serif;
    background: 
        radial-gradient(circle at 20% 80%, rgba(139, 69, 19, 0.4) 0%, transparent 50%),
        radial-gradient(circle at 80% 20%, rgba(160, 82, 45, 0.4) 0%, transparent 50%),
        radial-gradient(circle at 40% 40%, rgba(210, 180, 140, 0.3) 0%, transparent 50%),
        linear-gradient(135deg, #8B4513 0%, #D2B48C 25%, #F5DEB3 50%, #DEB887 75%, #CD853F 100%);
    min-height: 100vh;
    background-attachment: fixed;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    background: 
        radial-gradient(circle at 15% 85%, rgba(101, 67, 33, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 85% 15%, rgba(139, 69, 19, 0.15) 0%, transparent 40%),
        radial-gradient(circle at 50% 50%, rgba(160, 82, 45, 0.08) 0%, transparent 60%),
        linear-gradient(45deg, rgba(245, 222, 179, 0.97) 0%, rgba(240, 230, 140, 0.98) 50%, rgba(238, 232, 170, 0.96) 100%);
    border: 4px solid #8B4513;
    border-radius: 0;
    padding: 30px;
    box-shadow: 
        inset 0 0 60px rgba(139, 69, 19, 0.3),
        inset 0 0 20px rgba(160, 82, 45, 0.2),
        0 0 80px rgba(0, 0, 0, 0.6),
        0 0 120px rgba(139, 69, 19, 0.3);
    position: relative;
}

.container::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: 
        repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(139, 69, 19, 0.04) 2px, rgba(139, 69, 19, 0.04) 3px),
        repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(139, 69, 19, 0.04) 2px, rgba(139, 69, 19, 0.04) 3px),
        radial-gradient(circle at 20% 30%, rgba(139, 69, 19, 0.06) 0%, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(160, 82, 45, 0.05) 0%, transparent 40%);
    pointer-events: none;
}

.container::after {
    content: '';
    position: absolute;
    top: 12px;
    left: 12px;
    right: 12px;
    bottom: 12px;
    border: 2px solid rgba(139, 69, 19, 0.5);
    border-radius: 0;
    pointer-events: none;
    background-image: 
        radial-gradient(circle at 25px 25px, rgba(139, 69, 19, 0.08) 2px, transparent 2px),
        radial-gradient(circle at 75px 75px, rgba(160, 82, 45, 0.06) 2px, transparent 2px),
        linear-gradient(45deg, transparent 25%, rgba(139, 69, 19, 0.02) 25%, rgba(139, 69, 19, 0.02) 50%, transparent 50%, transparent 75%, rgba(139, 69, 19, 0.02) 75%);
    background-size: 50px 50px, 100px 100px, 20px 20px;
}

h1 {
    text-align: center;
    color: #654321;
    margin-bottom: 20px;
    font-weight: 600;
    font-size: 2.6em;
    text-shadow: 3px 3px 6px rgba(139, 69, 19, 0.4);
    letter-spacing: 3px;
    font-family: 'Cinzel Decorative', 'Cinzel', serif;
    text-transform: uppercase;
    position: relative;
}

h1::before {
    content: '☽ ';
    color: #8B4513;
    font-size: 0.8em;
}

h1::after {
    content: ' ☾';
    color: #8B4513;
    font-size: 0.8em;
}

.subtitle {
    text-align: center;
    color: #8B4513;
    margin-bottom: 30px;
    font-style: italic;
    font-size: 16px;
    font-family: 'Cinzel', serif;
    letter-spacing: 1px;
    text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.2);
}

#map-container {
    width: 100%;
    height: 500px;
    border: 5px solid #8B4513;
    border-radius: 0;
    overflow: hidden;
    position: relative;
    background: 
        radial-gradient(ellipse at 25% 25%, rgba(72, 61, 139, 0.5) 0%, transparent 60%),
        radial-gradient(ellipse at 75% 75%, rgba(32, 178, 170, 0.4) 0%, transparent 60%),
        linear-gradient(180deg, #4682B4 0%, #5F9EA0 40%, #2F4F4F 100%);
    margin-bottom: 25px;
    box-shadow: 
        inset 0 0 40px rgba(139, 69, 19, 0.5),
        inset 0 0 15px rgba(0, 0, 0, 0.3),
        0 8px 20px rgba(0, 0, 0, 0.4);
}

#map-container::before {
    content: '';
    position: absolute;
    top: 10px;
    left: 10px;
    right: 10px;
    bottom: 10px;
    border: 3px solid rgba(139, 69, 19, 0.7);
    pointer-events: none;
    z-index: 10;
}

#italy-insert {
    position: absolute;
    top: 20px;
    left: 20px;
    width: 200px;
    height: 250px;
    background: 
        radial-gradient(circle at 30% 30%, rgba(245, 222, 179, 1) 0%, rgba(240, 230, 140, 0.98) 100%);
    border: 4px solid #8B4513;
    border-radius: 0;
    padding: 10px;
    box-shadow: 
        inset 0 0 25px rgba(139, 69, 19, 0.3),
        0 6px 20px rgba(0, 0, 0, 0.5);
    z-index: 100;
}

#italy-insert::before {
    content: '';
    position: absolute;
    top: 4px;
    left: 4px;
    right: 4px;
    bottom: 4px;
    border: 2px solid rgba(139, 69, 19, 0.5);
    pointer-events: none;
}

#italy-insert::after {
    content: '';
    position: absolute;
    top: -2px;
    left: -2px;
    right: -2px;
    bottom: -2px;
    border: 1px solid rgba(184, 134, 11, 0.6);
    pointer-events: none;
}

#italy-insert h4 {
    margin: 0 0 10px 0;
    text-align: center;
    font-size: 13px;
    color: #654321;
    font-weight: bold;
    font-family: 'Cinzel', serif;
    letter-spacing: 1px;
    text-transform: uppercase;
    text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.2);
}

.italy-location {
    cursor: pointer;
    transition: all 0.4s ease;
    filter: drop-shadow(0 2px 4px rgba(139, 69, 19, 0.3));
}

.italy-location.inactive {
    opacity: 0.4;
}

.italy-location.active {
    opacity: 1;
    filter: drop-shadow(0 0 15px currentColor) drop-shadow(0 2px 4px rgba(139, 69, 19, 0.3));
    animation: ancientPulse 2.5s ease-in-out infinite;
}

@keyframes ancientPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.3); }
}

.connection-line {
    stroke: rgba(184, 134, 11, 0.6);
    stroke-width: 3px;
    stroke-dasharray: 6,4;
    fill: none;
    opacity: 0;
    pointer-events: none;
    animation: ancientDash 3s linear infinite;
}

.connection-line.active {
    opacity: 0.9;
}

@keyframes ancientDash {
    to { stroke-dashoffset: -10; }
}

.manuscript-path {
    fill: none;
    stroke-width: 4px;
    stroke-linecap: round;
    opacity: 0;
    stroke-dasharray: 1000;
    stroke-dashoffset: 1000;
    filter: drop-shadow(0 0 3px rgba(0, 0, 0, 0.4));
}

.manuscript-path.animate {
    animation: drawAncientPath 4s ease-in-out forwards;
    opacity: 0.8;
}

@keyframes drawAncientPath {
    to {
        stroke-dashoffset: 0;
    }
}

.manuscript-path.ptolemy_geography { stroke: #4A148C; }
.manuscript-path.vergilius_vaticanus { stroke: #1A237E; }
.manuscript-path.federico_bible_volume_1 { stroke: #B8860B; }
.manuscript-path.federico_bible_volume_2 { stroke: #8B4513; }
.manuscript-path.mixtec_codex_vat_lat_3773 { stroke: #654321; }

#timeline-container {
    width: 100%;
    height: 280px;
    border: 4px solid #8B4513;
    border-radius: 0;
    background: 
        linear-gradient(45deg, rgba(245, 222, 179, 0.96) 0%, rgba(240, 230, 140, 0.98) 100%);
    position: relative;
    overflow: hidden;
    margin-top: 25px;
    box-shadow: 
        inset 0 0 30px rgba(139, 69, 19, 0.3),
        0 4px 15px rgba(0, 0, 0, 0.3);
}

#timeline-container::before {
    content: '';
    position: absolute;
    top: 8px;
    left: 8px;
    right: 8px;
    bottom: 8px;
    border: 2px solid rgba(139, 69, 19, 0.4);
    pointer-events: none;
    z-index: 5;
}

#timeline-container::after {
    content: '';
    position: absolute;
    top: 6px;
    left: 6px;
    right: 6px;
    bottom: 6px;
    border: 1px solid rgba(139, 69, 19, 0.3);
    pointer-events: none;
    z-index: 5;
}

.country {
    fill: rgba(245, 222, 179, 0.8);
    stroke: #8B4513;
    stroke-width: 1px;
    transition: all 0.3s ease;
}

.country:hover {
    fill: rgba(240, 230, 140, 0.9);
}

.graticule {
    fill: none;
    stroke: rgba(139, 69, 19, 0.3);
    stroke-width: 0.8px;
    stroke-dasharray: 2,2;
}

.historical-location {
    stroke: rgba(245, 222, 179, 0.9);
    stroke-width: 3px;
    cursor: pointer;
    transition: all 0.4s ease;
    filter: drop-shadow(0 2px 4px rgba(139, 69, 19, 0.4));
}

.historical-location.inactive {
    opacity: 0.3;
}

.historical-location.active {
    opacity: 1;
    filter: drop-shadow(0 0 20px currentColor) drop-shadow(0 2px 4px rgba(139, 69, 19, 0.4));
    stroke-width: 4px;
}

.historical-ring {
    fill: none;
    stroke-width: 3px;
    opacity: 0.4;
    stroke-dasharray: 4,2;
    animation: ancientRingPulse 3s ease-in-out infinite;
}

.historical-ring.active {
    opacity: 0.8;
}

@keyframes ancientRingPulse {
    0%, 100% { stroke-dashoffset: 0; }
    50% { stroke-dashoffset: 6; }
}

.historical-label {
    font-size: 11px;
    font-weight: bold;
    fill: #654321;
    text-anchor: middle;
    pointer-events: none;
    text-shadow: 2px 2px 4px rgba(245, 222, 179, 0.9);
    opacity: 0;
    font-family: 'Cinzel', serif;
}

.historical-label.active {
    opacity: 1;
}

.temporal-line {
    fill: none;
    stroke-width: 4px;
    opacity: 0;
    stroke-dasharray: 8,4;
    stroke-linecap: round;
}

.temporal-line.active {
    opacity: 0.9;
}

.controls {
    display: flex;
    flex-direction: row;
    gap: 12px;
    margin-bottom: 20px;
    justify-content: center;
    flex-wrap: wrap;
}

.control-btn {
    background: 
        linear-gradient(45deg, rgba(245, 222, 179, 0.95) 0%, rgba(240, 230, 140, 0.95) 100%);
    border: 2px solid #8B4513;
    padding: 12px 18px;
    border-radius: 0;
    cursor: pointer;
    font-weight: bold;
    font-family: 'Cinzel', serif;
    color: #654321;
    transition: all 0.3s ease;
    box-shadow: 
        0 3px 8px rgba(139, 69, 19, 0.3),
        inset 0 1px 2px rgba(245, 222, 179, 0.8);
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 12px;
    position: relative;
    overflow: hidden;
}

.control-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
    transition: left 0.5s ease;
}

.control-btn:hover {
    background: linear-gradient(45deg, rgba(240, 230, 140, 1) 0%, rgba(245, 222, 179, 1) 100%);
    transform: translateY(-2px);
    box-shadow: 
        0 6px 12px rgba(139, 69, 19, 0.4),
        inset 0 1px 2px rgba(245, 222, 179, 0.9);
}

.control-btn:hover::before {
    left: 100%;
}

.control-btn.active {
    background: linear-gradient(45deg, #B8860B 0%, #DAA520 100%);
    color: rgba(245, 222, 179, 1);
    box-shadow: 
        0 2px 6px rgba(139, 69, 19, 0.5),
        inset 0 1px 2px rgba(255, 255, 255, 0.2);
}

.info-panel {
    position: absolute;
    top: 15px;
    right: 15px;
    background: 
        radial-gradient(circle at 20% 20%, rgba(245, 222, 179, 1) 0%, rgba(240, 230, 140, 0.98) 100%);
    padding: 20px;
    border: 3px solid #8B4513;
    border-radius: 0;
    box-shadow: 
        inset 0 0 25px rgba(139, 69, 19, 0.25),
        0 8px 25px rgba(0, 0, 0, 0.5);
    min-width: 300px;
    max-height: 420px;
    overflow-y: auto;
    display: none;
    z-index: 1000;
    font-family: 'Cinzel', serif;
}

.info-panel::before {
    content: '';
    position: absolute;
    top: 3px;
    left: 3px;
    right: 3px;
    bottom: 3px;
    border: 2px solid rgba(139, 69, 19, 0.4);
    pointer-events: none;
}

.info-panel h3 {
    margin: 0 0 15px 0;
    color: #654321;
    font-family: 'Cinzel', serif;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    text-shadow: 1px 1px 2px rgba(139, 69, 19, 0.2);
}

.info-panel p {
    margin: 8px 0;
    color: #8B4513;
    font-size: 14px;
    line-height: 1.4;
}

.timeline-event {
    cursor: pointer;
    transition: all 0.4s ease;
    filter: drop-shadow(0 1px 3px rgba(139, 69, 19, 0.3));
}

.timeline-event.inactive {
    opacity: 0.4;
}

.timeline-event.active {
    opacity: 1;
    transform: scale(1.1);
}

.timeline-circle {
    transition: all 0.4s ease;
    stroke: rgba(245, 222, 179, 0.9);
    stroke-width: 3px;
}

.timeline-circle.active {
    filter: drop-shadow(0 0 15px currentColor);
    stroke-width: 4px;
}

.timeline-label {
    font-size: 10px;
    font-weight: bold;
    text-anchor: middle;
    pointer-events: none;
    transition: opacity 0.3s ease;
    fill: #654321;
    font-family: 'Cinzel', serif;
    text-shadow: 1px 1px 2px rgba(245, 222, 179, 0.8);
}

.timeline-event-label {
    fill: #654321;
    font-family: 'Cinzel', serif;
    text-shadow: 1px 1px 2px rgba(245, 222, 179, 0.8);
}

.progress-line {
    stroke: #B8860B;
    stroke-width: 5px;
    opacity: 0.9;
    filter: drop-shadow(0 0 8px #B8860B);
}

.manuscript-track {
    stroke-width: 3px;
    opacity: 0.6;
    stroke-dasharray: 4,2;
}

.density-circle {
    stroke: #B8860B;
    fill: rgba(184, 134, 11, 0.3);
    filter: drop-shadow(0 2px 4px rgba(139, 69, 19, 0.3));
}

.convergence-line {
    stroke: #B8860B;
    stroke-width: 4px;
    stroke-dasharray: 6,4;
    opacity: 0.9;
    filter: drop-shadow(0 0 8px #B8860B);
}

.loading {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: #654321;
    font-size: 18px;
    z-index: 1001;
    font-family: 'Cinzel', serif;
    text-align: center;
}

.spinner {
    border: 4px solid rgba(139, 69, 19, 0.3);
    border-top: 4px solid #8B4513;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: ancientSpin 2s ease-in-out infinite;
    margin: 0 auto 15px;
}

@keyframes ancientSpin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.legend-item {
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 0;
    transition: all 0.3s ease;
    font-family: 'Cinzel', serif;
    font-size: 12px;
    color: #654321;
    border: 1px solid transparent;
}

.legend-item:hover {
    background-color: rgba(139, 69, 19, 0.15);
    border: 1px solid rgba(139, 69, 19, 0.3);
}

.legend-item[data-manuscript="ptolemy_geography"] span { color: #4A148C; }
.legend-item[data-manuscript="vergilius_vaticanus"] span { color: #1A237E; }
.legend-item[data-manuscript="federico_bible_volume_1"] span { color: #B8860B; }
.legend-item[data-manuscript="federico_bible_volume_2"] span { color: #8B4513; }
.legend-item[data-manuscript="mixtec_codex_vat_lat_3773"] span { color: #654321; }

svg text {
    font-family: 'Cinzel', serif;
}
    </style>
</head>
<body>
    <div class="container">
        <h1>Vatican Manuscript Convergence</h1>
      <!---  <p class="subtitle">Five Manuscripts, Five Cultures, One Universal Library (160 CE - 1700 CE)</p>
    -->
        <div id="map-container">
            <div class="loading" id="loading">
                <div class="spinner"></div>
                Loading manuscript data...
            </div>
            
            <div id="italy-insert">
                <h4>Italian Renaissance Centers</h4>
                <svg id="italy-svg" width="190" height="210"></svg>
            </div>
            
            <div class="controls">
                <button class="control-btn" onclick="zoomIn()">🔍 Zoom In</button>
                <button class="control-btn" onclick="zoomOut()">🔍 Zoom Out</button>
                <button class="control-btn" onclick="resetView()">🏠 Reset View</button>
                <button class="control-btn" onclick="toggleAnimation()" id="animateBtn">▶️ Play All Journeys</button>
                <button class="control-btn" onclick="showManuscriptPaths()" id="pathsBtn">📜 Show Paths</button>
                <button class="control-btn" onclick="focusItaly()" id="italyBtn">🇮🇹 Focus Italy</button>
            </div>
            
            <div class="info-panel" id="info-panel">
                <h3 id="location-name">Historical Location</h3>
                <p id="location-info">Click on any location to see details</p>
            </div>
            
            <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(255, 255, 255, 0.9); padding: 10px; border-radius: 8px; font-size: 11px;">
                <div style="font-weight: bold; margin-bottom: 8px;">Manuscript Legends</div>
                <div class="legend-item" data-manuscript="ptolemy_geography" style="cursor: pointer; padding: 2px 0; border-radius: 3px; transition: background-color 0.2s;"><span style="color: #8e44ad;">●</span> Ptolemy's Geography</div>
                <div class="legend-item" data-manuscript="vergilius_vaticanus" style="cursor: pointer; padding: 2px 0; border-radius: 3px; transition: background-color 0.2s;"><span style="color: #16a085;">●</span> Vergilius Vaticanus</div>
                <div class="legend-item" data-manuscript="federico_bible_volume_1" style="cursor: pointer; padding: 2px 0; border-radius: 3px; transition: background-color 0.2s;"><span style="color: #e67e22;">●</span> Federico's Bible Vol 1</div>
                <div class="legend-item" data-manuscript="federico_bible_volume_2" style="cursor: pointer; padding: 2px 0; border-radius: 3px; transition: background-color 0.2s;"><span style="color: #d35400;">●</span> Federico's Bible Vol 2</div>
                <div class="legend-item" data-manuscript="mixtec_codex_vat_lat_3773" style="cursor: pointer; padding: 2px 0; border-radius: 3px; transition: background-color 0.2s;"><span style="color: #8b4513;">●</span> Mixtec Codex</div>
            </div>
        </div>

        <div id="timeline-container"></div>
    </div>

    <script>
        // Loaded at runtime
        let comprehensiveManuscriptData = null;

        // Loaded at runtime
        let manuscriptMetadata = null;

        // Loaded at runtime
        window.italianLocations = null;

        // Chronological timeline
        const chronologicalTimeline = [
            { "time": "160 CE", "year": 160, "manuscripts": ["ptolemy_geography"], "count": 1 },
            { "time": "400 CE", "year": 400, "manuscripts": ["vergilius_vaticanus"], "count": 1 },
            { "time": "850 CE", "year": 850, "manuscripts": ["vergilius_vaticanus"], "count": 1 },
            { "time": "1400 CE", "year": 1400, "manuscripts": ["mixtec_codex_vat_lat_3773"], "count": 1 },
            { "time": "1406 CE", "year": 1406, "manuscripts": ["ptolemy_geography"], "count": 1 },
            { "time": "1460 CE", "year": 1460, "manuscripts": ["ptolemy_geography", "federico_bible_volume_1"], "count": 2 },
            { "time": "1476 CE", "year": 1476, "manuscripts": ["federico_bible_volume_2"], "count": 1 },
            { "time": "1477 CE", "year": 1477, "manuscripts": ["federico_bible_volume_2"], "count": 1 },
            { "time": "1478 CE", "year": 1478, "manuscripts": ["federico_bible_volume_2"], "count": 1 },
            { "time": "1521 CE", "year": 1521, "manuscripts": ["vergilius_vaticanus"], "count": 1 },
            { "time": "1600 CE", "year": 1600, "manuscripts": ["vergilius_vaticanus"], "count": 1 },
            { "time": "1657 CE", "year": 1657, "manuscripts": ["ptolemy_geography", "federico_bible_volume_1", "federico_bible_volume_2"], "count": 3 },
            { "time": "1700 CE", "year": 1700, "manuscripts": ["mixtec_codex_vat_lat_3773"], "count": 1 }
        ];

        // Map setup
        const mapWidth = 1160, mapHeight = 500;
        const timelineWidth = 1160, timelineHeight = 280;
        let currentTransform = d3.zoomIdentity;
        let animationRunning = false;
        let activeLocationIndex = -1;
        let pathsVisible = false;

        // Create SVGs
        const mapSvg = d3.select("#map-container").append("svg").attr("width", mapWidth).attr("height", mapHeight);
        const timelineSvg = d3.select("#timeline-container").append("svg").attr("width", timelineWidth).attr("height", timelineHeight);
        const italySvg = d3.select("#italy-svg");
        // Ensure responsive scaling inside the insert
        italySvg.attr("viewBox", "0 0 190 210").attr("preserveAspectRatio", "xMidYMid meet");

        // Projection and zoom
        const projection = d3.geoNaturalEarth1().scale(150).translate([mapWidth / 2, mapHeight / 2]);
        const path = d3.geoPath().projection(projection);
        const zoom = d3.zoom().scaleExtent([0.5, 8]).on("zoom", zoomed);
        mapSvg.call(zoom);

        // Italy projection for insert (fit to data at draw time)
        const italyProjection = d3.geoMercator()
            .center([12.5, 42.5])
            .scale(1)
            .translate([0, 0]);
        const italyPath = d3.geoPath().projection(italyProjection);

        function fitProjectionToFeature(projection, feature, width, height, padding) {
            try {
                projection.fitExtent([[padding, padding], [width - padding, height - padding]], feature);
            } catch (e) {
                console.warn("fitProjectionToFeature failed:", e);
            }
        }

        const g = mapSvg.append("g");
        let worldData = null;

        async function loadWorldData() {
            try {
                const response = await fetch('https://d2ad6b4ur7yvpq.cloudfront.net/naturalearth-3.3.0/ne_50m_admin_0_countries.geojson');
                const data = await response.json();
                worldData = data;
                document.getElementById('loading').style.display = 'none';
                
                drawCountries();
                drawHistoricalLocations();
                // Draw fallback first; will be replaced when Italy TopoJSON loads
                drawItalyInsert();
                drawManuscriptConnections();
                drawTimeline();
                addInteractiveFeatures();
                // Load high-resolution Italy TopoJSON asynchronously and redraw inset on success
                loadItalyData();
                console.log("Enhanced multi-path manuscript map loaded successfully!");
            } catch (error) {
                console.error("Error loading world data:", error);
                document.getElementById('loading').innerHTML = '<div style="color: #e74c3c;"><strong>Error loading map data</strong></div>';
            }
        }

        async function loadItalyData() {
            try {
                const topoUrl = 'true.json';
                const resp = await fetch(topoUrl);
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const topo = await resp.json();
                const objectKeys = topo && topo.objects ? Object.keys(topo.objects) : [];
                if (objectKeys.length === 0) throw new Error('No objects in Topology');
                const objKey = objectKeys[0];
                const featureCollection = topojson.feature(topo, topo.objects[objKey]);
                if (!featureCollection || !featureCollection.features || featureCollection.features.length === 0) {
                    throw new Error('Empty feature collection from TopoJSON');
                }
                window.italyGeoData = featureCollection;
                console.log(`Italy TopoJSON loaded with object key: ${objKey}, features: ${featureCollection.features.length}`);
                // Redraw inset using the loaded data
                drawItalyInsert();
            } catch (e) {
                console.warn('Failed to load Italy TopoJSON; using fallback outline.', e);
            }
        }

        function drawCountries() {
            if (!worldData) return;
            g.selectAll(".country")
                .data(worldData.features)
                .enter().append("path")
                .attr("class", "country")
                .attr("d", path)
                .style("opacity", 0)
                .transition().duration(1000).style("opacity", 1);

            // Add graticule
            const graticule = d3.geoGraticule();
            g.append("path").datum(graticule).attr("class", "graticule").attr("d", path);
        }

        function drawItalyInsert() {
            if (!window.italyGeoData) {
                drawItalyInsertFallback();
                return;
            }

            try {
                // Clear any existing content
                italySvg.selectAll("*").remove();
                const svgW = +italySvg.attr("width") || 190;
                const svgH = +italySvg.attr("height") || 210;

                // Fit projection to Italy feature collection
                const featureCollection = { type: "FeatureCollection", features: window.italyGeoData.features };
                fitProjectionToFeature(italyProjection, featureCollection, svgW, svgH, 8);

                // Draw Italy regions using the provided geojson data
                italySvg.selectAll(".italy-region")
                    .data(window.italyGeoData.features)
                    .enter().append("path")
                    .attr("class", "italy-region")
                    .attr("d", italyPath)
                    .style("fill", "#eef5fb")
                    .style("stroke", "#1a5f8a")
                    .style("stroke-width", "1.5px")
                    .style("opacity", 1)
                    .style("filter", "drop-shadow(0 0 3px rgba(0,0,0,0.3))");

                drawItalyLocations();
                
            } catch (error) {
                console.error("Error drawing Italy insert:", error);
                drawItalyInsertFallback();
            }
        }

        function drawItalyInsertFallback() {
            // Fallback: draw a simple Italy outline from world data
            const italyFeature = worldData?.features?.find(d => {
                const p = d.properties || {};
                return (
                    p.ADMIN === "Italy" ||
                    p.NAME === "Italy" ||
                    p.NAME_EN === "Italy" ||
                    p.NAME_LONG === "Italy" ||
                    p.SOVEREIGNT === "Italy" ||
                    p.ISO_A3 === "ITA" ||
                    p.ADM0_A3 === "ITA" ||
                    p.ADM0_A3_US === "ITA"
                );
            });
            
            if (italyFeature) {
                // Fit projection to the Italy polygon from world dataset
                const svgW = +italySvg.attr("width") || 190;
                const svgH = +italySvg.attr("height") || 210;
                fitProjectionToFeature(italyProjection, italyFeature, svgW, svgH, 8);

                italySvg.append("path")
                    .datum(italyFeature)
                    .attr("d", italyPath)
                    .style("fill", "#eef5fb")
                    .style("stroke", "#1a5f8a")
                    .style("stroke-width", "1.5px")
                    .style("opacity", 1)
                    .style("filter", "drop-shadow(0 0 3px rgba(0,0,0,0.3))");
            } else {
                // If we can't find Italy and have no geojson, draw a very light inline outline (mainland + Sicily + Sardinia)
                const svgW = +italySvg.attr("width") || 190;
                const svgH = +italySvg.attr("height") || 210;
                const fallbackItalyGeo = {
                    type: "FeatureCollection",
                    features: [
                        {
                            type: "Feature",
                            properties: { name: "Italy (approx mainland)" },
                            geometry: {
                                type: "Polygon",
                                coordinates: [[
                                    [6.6, 46.2], [9.0, 45.8], [10.5, 45.8], [12.3, 45.8], [13.8, 45.7],
                                    [14.5, 44.9], [15.1, 44.2], [15.5, 43.5], [16.0, 42.5], [16.5, 41.6],
                                    [17.2, 41.2], [18.3, 40.2], [18.4, 39.8], [17.2, 39.6], [16.5, 39.0],
                                    [16.0, 38.8], [15.6, 38.6], [15.4, 38.2], [15.2, 38.0], [14.8, 38.7],
                                    [14.2, 39.5], [13.6, 40.2], [12.8, 41.1], [12.2, 41.4], [11.3, 42.0],
                                    [10.4, 42.5], [9.6, 43.1], [9.0, 43.5], [8.2, 44.0], [7.5, 44.4], [6.8, 44.9],
                                    [6.6, 46.2]
                                ]]
                            }
                        },
                        {
                            type: "Feature",
                            properties: { name: "Sicily (approx)" },
                            geometry: {
                                type: "Polygon",
                                coordinates: [[
                                    [12.4, 38.3], [13.0, 37.4], [13.8, 37.0], [14.8, 36.8], [15.4, 37.0],
                                    [15.5, 37.3], [15.2, 37.9], [14.7, 38.2], [13.9, 38.4], [13.2, 38.6],
                                    [12.6, 38.6], [12.4, 38.3]
                                ]]
                            }
                        },
                        {
                            type: "Feature",
                            properties: { name: "Sardinia (approx)" },
                            geometry: {
                                type: "Polygon",
                                coordinates: [[
                                    [8.1, 41.2], [8.6, 41.1], [9.2, 40.8], [9.4, 40.2], [9.3, 39.5],
                                    [8.9, 39.1], [8.4, 39.2], [8.2, 39.7], [8.1, 40.4], [8.1, 41.2]
                                ]]
                            }
                        }
                    ]
                };

                fitProjectionToFeature(italyProjection, fallbackItalyGeo, svgW, svgH, 8);
                italySvg.selectAll(".italy-region-inline")
                    .data(fallbackItalyGeo.features)
                    .enter().append("path")
                    .attr("class", "italy-region-inline")
                    .attr("d", italyPath)
                    .style("fill", "#eef5fb")
                    .style("stroke", "#1a5f8a")
                    .style("stroke-width", "1.5px")
                    .style("opacity", 1)
                    .style("filter", "drop-shadow(0 0 3px rgba(0,0,0,0.3))");
            }

            drawItalyLocations();
        }

        function drawItalyLocations() {
            // Draw Italian locations
            const pointOffsets = {
                "Rome": { dx: -6, dy: 0 },
                "Florence": { dx: 6, dy: -2 },
                "Urbino": { dx: -4, dy: 6 },
                "Vatican City": { dx: 2, dy: 6 }
            };

            const italyLocations = italySvg.selectAll(".italy-location-group")
                .data(window.italianLocations)
                .enter().append("g")
                .attr("class", "italy-location-group")
                .attr("transform", d => {
                    const coords = italyProjection([d.coordinates.longitude, d.coordinates.latitude]);
                    const off = pointOffsets[d.name] || { dx: 0, dy: 0 };
                    return `translate(${coords[0] + off.dx}, ${coords[1] + off.dy})`;
                });

            // Add location markers
            italyLocations.append("circle")
                .attr("class", "italy-location inactive")
                .attr("r", 6)
                .style("fill", "#e74c3c")
                .style("stroke", "none")
                .style("opacity", 0.9)
                .style("filter", "drop-shadow(0 0 4px rgba(0,0,0,0.5))")
                .on("click", function(event, d) {
                    const relevantTime = d.times[0]; // Get first time for this location
                    const timeIndex = chronologicalTimeline.findIndex(t => t.time === relevantTime);
                    if (timeIndex !== -1) setActiveLocation(timeIndex);
                });

            // Add labels with simple per-city offset to reduce overlap
            const labelOffsets = {
                "Rome": { dx: 6, dy: -10 },
                "Florence": { dx: -10, dy: -12 },
                "Urbino": { dx: 8, dy: -6 },
                "Vatican City": { dx: 10, dy: 6 }
            };

            italyLocations.append("text")
                .attr("class", "italy-label")
                .attr("dx", d => (labelOffsets[d.name]?.dx ?? 6))
                .attr("dy", d => (labelOffsets[d.name]?.dy ?? -8))
                .style("text-anchor", "start")
                .style("font-size", "7px")
                .style("font-weight", "bold")
                .style("fill", "#2c3e50")
                .style("paint-order", "stroke")
                .style("stroke", "#fff")
                .style("stroke-width", "2px")
                .text(d => d.name);
        }

        function drawManuscriptConnections() {
            const connectionGroup = g.append("g").attr("class", "manuscript-connections");
            
            // Create paths between consecutive locations for each manuscript
            Object.keys(manuscriptMetadata).forEach(manuscript => {
                const manuscriptEvents = [];
                
                Object.entries(comprehensiveManuscriptData).forEach(([time, locations]) => {
                    locations.forEach(loc => {
                        if (loc.manuscript === manuscript || (loc.manuscripts && loc.manuscripts.some(ms => ms.name === manuscript))) {
                            manuscriptEvents.push({...loc, time});
                        }
                    });
                });
                
                // Sort by time
                manuscriptEvents.sort((a, b) => {
                    const yearA = parseInt(a.time.split(' ')[0]);
                    const yearB = parseInt(b.time.split(' ')[0]);
                    return yearA - yearB;
                });

                // Draw paths between consecutive events
                for (let i = 0; i < manuscriptEvents.length - 1; i++) {
                    const start = manuscriptEvents[i];
                    const end = manuscriptEvents[i + 1];
                    
                    const startCoords = projection([start.coordinates.longitude, start.coordinates.latitude]);
                    const endCoords = projection([end.coordinates.longitude, end.coordinates.latitude]);
                    
                    const pathData = `M${startCoords[0]},${startCoords[1]} Q${(startCoords[0] + endCoords[0])/2},${(startCoords[1] + endCoords[1])/2 - 50} ${endCoords[0]},${endCoords[1]}`;
                    
                    const p = connectionGroup.append("path")
                        .attr("class", `manuscript-path ${manuscript}`)
                        .attr("d", pathData)
                        .style("stroke", manuscriptMetadata[manuscript].color)
                        .style("stroke-width", "3px")
                        .style("stroke-linecap", "round")
                        .style("opacity", 0);

                    // Compute and store actual path length, and initialize dasharray/offset to that length
                    p.each(function() {
                        try {
                            const length = this.getTotalLength();
                            d3.select(this)
                                .attr("data-length", length)
                                .style("stroke-dasharray", length)
                                .style("stroke-dashoffset", length);
                        } catch (e) {
                            // Fallback to a safe default if getTotalLength fails
                            d3.select(this)
                                .attr("data-length", 1000)
                                .style("stroke-dasharray", 1000)
                                .style("stroke-dashoffset", 1000);
                        }
                    });
                }
            });
        }

        function drawHistoricalLocations() {
            // Get all unique locations from all manuscripts
            const allLocations = [];
            Object.entries(comprehensiveManuscriptData).forEach(([time, locations]) => {
                locations.forEach((loc) => {
                    const manuscript = loc.manuscript || "unknown";
                    const timeIndex = chronologicalTimeline.findIndex(t => t.time === time);
                    
                    allLocations.push({
                        ...loc,
                        time: time,
                        timeIndex: timeIndex,
                        manuscript: manuscript,
                        color: manuscriptMetadata[manuscript]?.color || "#333"
                    });
                });
            });

            const locations = g.selectAll(".historical-location-group")
                .data(allLocations)
                .enter().append("g")
                .attr("class", "historical-location-group")
                .attr("data-time-index", d => d.timeIndex)
                .attr("data-manuscript", d => d.manuscript)
                .attr("transform", d => {
                    const coords = projection([d.coordinates.longitude, d.coordinates.latitude]);
                    return `translate(${coords[0]}, ${coords[1]})`;
                });

            // Add rings (initially hidden)
            locations.append("circle")
                .attr("class", "historical-ring")
                .attr("r", 18)
                .style("stroke", d => d.color)
                .style("stroke-width", "2px")
                .style("opacity", 0);

            // Add location markers (initially hidden)
            locations.append("circle")
                .attr("class", "historical-location")
                .attr("r", 6)
                .style("fill", d => d.color)
                .style("stroke", "none")
                .style("opacity", 0)
                .on("click", function(event, d) {
                    showLocationInfo(d);
                    setActiveLocation(d.timeIndex);
                });

            // Add labels (initially hidden) - staggered positioning
            locations.append("text")
                .attr("class", "historical-label")
                .attr("dy", (d, i) => -12 - (i % 3) * 8) // Stagger labels vertically
                .attr("dx", (d, i) => (i % 2) * 10 - 5) // Stagger labels horizontally
                .text(d => `${d.location} (${d.time})`)
                .style("font-size", "9px")
                .style("fill", d => d.color)
                .style("font-weight", "bold")
                .style("opacity", 0);
        }

        function drawTimeline() {
            // Title
            timelineSvg.append("text")
                .attr("x", timelineWidth / 2).attr("y", 25)
                .style("text-anchor", "middle").style("font-size", "16px")
                .style("font-weight", "bold").style("fill", "#2c3e50")
                .text("Multi-Manuscript Timeline: 1,540 Years of Cultural Transmission");

            const timelineG = timelineSvg.append("g").attr("id", "timeline-main").attr("transform", "translate(80, 80)");
            
            const timelineScale = d3.scaleLinear().domain([160, 1700]).range([0, timelineWidth - 160]);

            // Calculate data density
            const dataDensity = {};
            chronologicalTimeline.forEach(event => {
                dataDensity[event.year] = event.count;
            });

            const maxDensity = Math.max(...Object.values(dataDensity));
            const densityScale = d3.scaleLinear().domain([1, maxDensity]).range([15, 40]);

            // Draw manuscript tracks
            const manuscripts = ["ptolemy_geography", "vergilius_vaticanus", "federico_bible_volume_1", "federico_bible_volume_2", "mixtec_codex_vat_lat_3773"];
            const trackY = [20, 40, 60, 80, 100];

            manuscripts.forEach((manuscript, i) => {
                const events = chronologicalTimeline.filter(t => t.manuscripts.includes(manuscript));
                
                // Draw manuscript track line
                if (events.length > 1) {
                    const startX = timelineScale(events[0].year);
                    const endX = timelineScale(events[events.length - 1].year);
                    
                    timelineG.append("line")
                        .attr("class", "manuscript-track")
                        .attr("x1", startX).attr("y1", trackY[i])
                        .attr("x2", endX).attr("y2", trackY[i])
                        .style("stroke", manuscriptMetadata[manuscript].color)
                        .style("opacity", 0.3);
                }

                // Add manuscript label
                timelineG.append("text")
                    .attr("x", -10).attr("y", trackY[i] + 3)
                    .style("text-anchor", "end").style("font-size", "9px").style("font-weight", "bold")
                    .style("fill", manuscriptMetadata[manuscript].color)
                    .text(manuscriptMetadata[manuscript].title.split(' ')[0]);
            });

            // Add proportional background circles for high-density events
            chronologicalTimeline.forEach(event => {
                if (event.count > 1) {
                    const radius = densityScale(event.count);
                    
                    timelineG.append("circle")
                        .attr("class", "density-circle")
                        .attr("cx", timelineScale(event.year))
                        .attr("cy", 60)
                        .attr("r", radius)
                        .style("fill", "#e74c3c")
                        .style("opacity", 0.2)
                        .style("stroke", "#e74c3c")
                        .style("stroke-width", "1px")
                        .style("stroke-opacity", 0.5);

                    // Add density count labels
                    timelineG.append("text")
                        .attr("x", timelineScale(event.year))
                        .attr("y", 60 - radius - 8)
                        .style("text-anchor", "middle")
                        .style("font-size", "10px")
                        .style("font-weight", "bold")
                        .style("fill", "#e74c3c")
                        .text(`${event.count} manuscripts`);
                }
            });

            // Create events for each manuscript individually
            const individualEvents = [];
            chronologicalTimeline.forEach((timeEvent, timeIndex) => {
                timeEvent.manuscripts.forEach(manuscript => {
                    const trackIndex = manuscripts.indexOf(manuscript);
                    individualEvents.push({
                        ...timeEvent,
                        manuscript: manuscript,
                        trackIndex: trackIndex,
                        trackY: trackY[trackIndex],
                        timeIndex: timeIndex
                    });
                });
            });

            // Draw individual events on their respective tracks
            const events = timelineG.selectAll(".timeline-event")
                .data(individualEvents)
                .enter().append("g")
                .attr("class", "timeline-event")
                .attr("data-index", d => d.timeIndex)
                .attr("data-manuscript", d => d.manuscript)
                .attr("transform", d => `translate(${timelineScale(d.year)}, ${d.trackY})`)
                .style("cursor", "pointer");

            events.append("circle")
                .attr("class", "timeline-circle")
                .attr("r", 5)
                .style("fill", d => manuscriptMetadata[d.manuscript].color)
                .style("stroke", "#fff")
                .style("stroke-width", "2px")
                .on("click", function(event, d) { 
                    setActiveLocation(d.timeIndex); 
                })
                .on("mouseover", function(event, d) {
                    // Show tooltip with manuscript details
                    const tooltip = d3.select("body").append("div")
                        .style("position", "absolute")
                        .style("background", "rgba(0, 0, 0, 0.8)")
                        .style("color", "white")
                        .style("padding", "10px")
                        .style("border-radius", "6px")
                        .style("font-size", "12px")
                        .style("pointer-events", "none")
                        .style("z-index", "10000")
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 40) + "px")
                        .html(`${d.time}<br/>${manuscriptMetadata[d.manuscript].title}<br/>Track: ${d.manuscript}`);
                    
                    setTimeout(() => tooltip.remove(), 1500);
                });

            // Add date labels next to each dot with collision avoidance
            events.each(function(d, i) {
                const element = d3.select(this);
                
                // Calculate label offset based on track position to avoid overlaps
                let labelOffset = 8;
                let verticalOffset = 3;
                
                // For events at the same year, stagger the labels
                const sameYearEvents = individualEvents.filter(e => e.year === d.year);
                if (sameYearEvents.length > 1) {
                    const eventIndex = sameYearEvents.indexOf(d);
                    // Alternate label positions: right, far right, above right, below right
                    switch(eventIndex % 4) {
                        case 0: labelOffset = 8; verticalOffset = 3; break;
                        case 1: labelOffset = 18; verticalOffset = 3; break;
                        case 2: labelOffset = 8; verticalOffset = -8; break;
                        case 3: labelOffset = 18; verticalOffset = -8; break;
                    }
                }
                
                element.append("text")
                    .attr("class", "timeline-event-label")
                    .attr("dx", labelOffset)
                    .attr("dy", verticalOffset)
                    .style("text-anchor", "start")
                    .style("font-size", "8px")
                    .style("fill", manuscriptMetadata[d.manuscript].color)
                    .style("font-weight", "bold")
                    .attr("transform", `rotate(-45, ${labelOffset}, ${verticalOffset})`)
                    .text(d.time);
            });

            // Add Vatican convergence indicator
            const vaticanX = timelineScale(1657);
            timelineG.append("line")
                .attr("class", "convergence-line")
                .attr("x1", vaticanX).attr("y1", 10)
                .attr("x2", vaticanX).attr("y2", 110)
                .style("stroke", "#e74c3c").style("stroke-width", "3px")
                .style("stroke-dasharray", "5,5").style("opacity", 0.8);

            timelineG.append("text")
                .attr("x", vaticanX).attr("y", 130)
                .style("text-anchor", "middle").style("font-size", "11px")
                .style("fill", "#e74c3c").style("font-weight", "bold")
                .text("VATICAN CONVERGENCE");
        }

        function setActiveLocation(index) {
            const eventData = chronologicalTimeline[index];
            if (!eventData) return;

            // Reset all locations
            g.selectAll(".historical-location").classed("active", false).style("opacity", 0.2);
            g.selectAll(".historical-ring").classed("active", false).style("opacity", 0);
            g.selectAll(".historical-label").classed("active", false).style("opacity", 0);
            
            // Reset Italy insert locations
            italySvg.selectAll(".italy-location").classed("active", false).classed("inactive", true);
            
            // Show all locations for this time period
            const timeKey = eventData.time;
            const locationData = comprehensiveManuscriptData[timeKey];
            
            if (locationData) {
                locationData.forEach(loc => {
                    g.selectAll(`.historical-location-group[data-manuscript="${loc.manuscript}"]`)
                        .filter(d => d.time === timeKey)
                        .select(".historical-location").classed("active", true).style("opacity", 1);
                    g.selectAll(`.historical-location-group[data-manuscript="${loc.manuscript}"]`)
                        .filter(d => d.time === timeKey)
                        .select(".historical-ring").classed("active", true).style("opacity", 0.6);
                    g.selectAll(`.historical-location-group[data-manuscript="${loc.manuscript}"]`)
                        .filter(d => d.time === timeKey)
                        .select(".historical-label").classed("active", true).style("opacity", 1);
                    
                    // Check if location is in Italy and highlight in insert
                    const italianLocation = window.italianLocations.find(italyLoc => 
                        italyLoc.name === loc.location && italyLoc.times.includes(timeKey)
                    );
                    
                    if (italianLocation) {
                        italySvg.selectAll(".italy-location-group")
                            .filter(d => d.name === italianLocation.name)
                            .select(".italy-location")
                            .classed("active", true)
                            .classed("inactive", false)
                            .style("opacity", 1)
                            .style("fill", manuscriptMetadata[loc.manuscript]?.color || "#e74c3c");
                    }
                });

                // Show info for primary location
                const primaryLocation = locationData[0];
                showLocationInfo({...primaryLocation, time: eventData.time, manuscripts: eventData.manuscripts});
                zoomToLocation(primaryLocation);
            }

            // Highlight timeline
            timelineSvg.selectAll(".timeline-event").classed("active", false).classed("inactive", true);
            timelineSvg.selectAll(`.timeline-event[data-index="${index}"]`)
                .classed("active", true).classed("inactive", false);
        }

        function showManuscriptPaths() {
            const btn = document.getElementById('pathsBtn');
            pathsVisible = !pathsVisible;
            
            if (pathsVisible) {
                btn.textContent = "📜 Hide Paths";
                btn.classList.add('active');
                
                // Animate manuscript paths sequentially
                const manuscripts = Object.keys(manuscriptMetadata);
                manuscripts.forEach((manuscript, index) => {
                    setTimeout(() => {
                        g.selectAll(`.manuscript-path.${manuscript}`)
                            .each(function() {
                                const sel = d3.select(this);
                                let L = +sel.attr("data-length");
                                if (!L || !isFinite(L)) {
                                    try { L = this.getTotalLength(); } catch (_) { L = 1000; }
                                    sel.attr("data-length", L);
                                }
                                sel.style("stroke-dasharray", L)
                                   .style("stroke-dashoffset", L)
                                   .style("opacity", 0.6)
                                   .transition()
                                   .duration(Math.min(5000, Math.max(1200, L * 3)))
                                   .ease(d3.easeCubicInOut)
                                   .style("stroke-dashoffset", 0)
                                   .style("opacity", 0.8);
                            });
                    }, index * 800);
                });
            } else {
                btn.textContent = "📜 Show Paths";
                btn.classList.remove('active');
                g.selectAll(".manuscript-path")
                    .each(function() {
                        const sel = d3.select(this);
                        let L = +sel.attr("data-length");
                        if (!L || !isFinite(L)) {
                            try { L = this.getTotalLength(); } catch (_) { L = 1000; }
                            sel.attr("data-length", L);
                        }
                        sel.transition()
                           .duration(500)
                           .style("opacity", 0)
                           .style("stroke-dashoffset", L);
                    });
            }
        }

        function focusItaly() {
            // Zoom to Italy region
            const italyBounds = [
                [6.7499552751, 36.619987291], // Southwest
                [18.4802470232, 47.1153931748] // Northeast
            ];
            
            const [[x0, y0], [x1, y1]] = italyBounds.map(d => projection(d));
            const scale = 0.9 / Math.max((x1 - x0) / mapWidth, (y1 - y0) / mapHeight);
            const translate = [mapWidth / 2 - scale * (x0 + x1) / 2, mapHeight / 2 - scale * (y0 + y1) / 2];
            
            mapSvg.transition().duration(1000)
                .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
            
            // Highlight Italian locations
            setTimeout(() => {
                g.selectAll(".historical-location-group")
                    .filter(d => ["Rome", "Florence", "Urbino", "Vatican City"].includes(d.location))
                    .select(".historical-location")
                    .transition()
                    .duration(800)
                    .style("r", 10)
                    .style("opacity", 1)
                    .transition()
                    .duration(800)
                    .style("r", 6);
            }, 1000);
        }

        function toggleAnimation() {
            const btn = document.getElementById('animateBtn');
            if (animationRunning) {
                animationRunning = false;
                btn.textContent = "▶️ Play All Journeys";
                btn.classList.remove('active');
            } else {
                playAnimation();
            }
        }

        function playAnimation() {
            if (animationRunning) return;
            animationRunning = true;
            
            const btn = document.getElementById('animateBtn');
            btn.textContent = "⏸️ Stop Animation";
            btn.classList.add('active');
            
            // Reset all locations first
            g.selectAll(".historical-location").style("opacity", 0.1);
            g.selectAll(".historical-ring").style("opacity", 0);
            g.selectAll(".historical-label").style("opacity", 0);
            
            // Play through all timeline events sequentially with enhanced effects
            chronologicalTimeline.forEach((event, index) => {
                setTimeout(() => {
                    setActiveLocation(index);
                    
                    // Add ripple effect for dramatic locations
                    if (event.count > 1) {
                        addRippleEffect(event);
                    }
                    
                    if (index === chronologicalTimeline.length - 1) {
                        setTimeout(() => {
                            animationRunning = false;
                            btn.textContent = "▶️ Play All Journeys";
                            btn.classList.remove('active');
                            
                            // Show convergence effect at Vatican
                            showVaticanConvergence();
                        }, 3000);
                    }
                }, index * 2800);
            });
        }

        function addRippleEffect(event) {
            const locationData = comprehensiveManuscriptData[event.time];
            if (!locationData) return;
            
            locationData.forEach(loc => {
                const coords = projection([loc.coordinates.longitude, loc.coordinates.latitude]);
                
                // Create animated ripple rings
                for (let i = 0; i < 3; i++) {
                    setTimeout(() => {
                        const ripple = g.append("circle")
                            .attr("cx", coords[0])
                            .attr("cy", coords[1])
                            .attr("r", 6)
                            .style("fill", "none")
                            .style("stroke", "#e74c3c")
                            .style("stroke-width", "3px")
                            .style("opacity", 0.8);
                        
                        ripple.transition()
                            .duration(1500)
                            .attr("r", 40)
                            .style("opacity", 0)
                            .remove();
                    }, i * 300);
                }
            });
        }

        function showVaticanConvergence() {
            const vaticanCoords = projection([12.4534, 41.9029]);
            
            // Create convergence lines from all manuscripts to Vatican
            Object.keys(manuscriptMetadata).forEach((manuscript, index) => {
                const manuscriptEvents = [];
                
                Object.entries(comprehensiveManuscriptData).forEach(([time, locations]) => {
                    locations.forEach(loc => {
                        if (loc.manuscript === manuscript || (loc.manuscripts && loc.manuscripts.some(ms => ms.name === manuscript))) {
                            manuscriptEvents.push({...loc, time});
                        }
                    });
                });
                
                if (manuscriptEvents.length > 0) {
                    const lastEvent = manuscriptEvents[manuscriptEvents.length - 1];
                    const lastCoords = projection([lastEvent.coordinates.longitude, lastEvent.coordinates.latitude]);
                    
                    setTimeout(() => {
                        const convergeLine = g.append("line")
                            .attr("x1", lastCoords[0])
                            .attr("y1", lastCoords[1])
                            .attr("x2", lastCoords[0])
                            .attr("y2", lastCoords[1])
                            .style("stroke", manuscriptMetadata[manuscript].color)
                            .style("stroke-width", "4px")
                            .style("opacity", 0.8);
                        
                        convergeLine.transition()
                            .duration(2000)
                            .attr("x2", vaticanCoords[0])
                            .attr("y2", vaticanCoords[1])
                            .transition()
                            .duration(1000)
                            .style("opacity", 0)
                            .remove();
                    }, index * 400);
                }
            });
            
            // Final Vatican glow effect
            setTimeout(() => {
                const vaticanGlow = g.append("circle")
                    .attr("cx", vaticanCoords[0])
                    .attr("cy", vaticanCoords[1])
                    .attr("r", 5)
                    .style("fill", "#FFD700")
                    .style("opacity", 0);
                
                vaticanGlow.transition()
                    .duration(1000)
                    .attr("r", 30)
                    .style("opacity", 0.6)
                    .transition()
                    .duration(1000)
                    .attr("r", 50)
                    .style("opacity", 0)
                    .remove();
            }, 3000);
        }

        function showLocationInfo(location) {
            const panel = document.getElementById('info-panel');
            const locationName = document.getElementById('location-name');
            const locationInfo = document.getElementById('location-info');
            
            locationName.textContent = `${location.location} (${location.time})`;
            
            let infoHtml = `<strong>📍 Event:</strong> ${location.event}<br/>`;
            infoHtml += `<strong>🌍 Country:</strong> ${location.country}<br/>`;
            infoHtml += `<strong>⏰ Period:</strong> ${location.period}<br/>`;
            infoHtml += `<strong>⚡ Role:</strong> ${location.role.replace(/_/g, ' ')}<br/>`;
            
            if (location.manuscripts && location.manuscripts.length > 1) {
                infoHtml += `<strong>📚 Manuscripts (${location.manuscripts.length}):</strong><br/>`;
                location.manuscripts.forEach(ms => {
                    const color = manuscriptMetadata[ms]?.color || '#333';
                    infoHtml += `<span style="color: ${color};">● </span>${manuscriptMetadata[ms]?.title || ms}<br/>`;
                });
            } else if (location.manuscript) {
                const color = manuscriptMetadata[location.manuscript]?.color || '#333';
                infoHtml += `<strong>📜 Manuscript:</strong> <span style="color: ${color};">${manuscriptMetadata[location.manuscript]?.title || location.manuscript}</span><br/>`;
            }
            
            // Additional contextual information
            if (location.patron) infoHtml += `<strong>👑 Patron:</strong> ${location.patron}<br/>`;
            if (location.workshop_director) infoHtml += `<strong>🎨 Workshop Director:</strong> ${location.workshop_director}<br/>`;
            if (location.scribe) infoHtml += `<strong>✍️ Scribe:</strong> ${location.scribe}<br/>`;
            if (location.culture) infoHtml += `<strong>🏛️ Culture:</strong> ${location.culture}<br/>`;
            if (location.institution) infoHtml += `<strong>🏛️ Institution:</strong> ${location.institution}<br/>`;
            if (location.pope) infoHtml += `<strong>⛪ Pope:</strong> ${location.pope}<br/>`;
            if (location.owner) infoHtml += `<strong>👤 Owner:</strong> ${location.owner}<br/>`;
            if (location.bequest) infoHtml += `<strong>📜 Bequest:</strong> ${location.bequest}<br/>`;
            if (location.transport_context) infoHtml += `<strong>⚔️ Context:</strong> ${location.transport_context}<br/>`;
            
            // Add manuscript count for multi-manuscript events
            if (location.manuscript_count && location.manuscript_count > 1) {
                infoHtml += `<strong>📊 Convergence Event:</strong> ${location.manuscript_count} manuscripts<br/>`;
            }
            
            locationInfo.innerHTML = infoHtml;
            panel.style.display = 'block';
            
            // Add smooth show animation
            panel.style.opacity = '0';
            panel.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                panel.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
                panel.style.opacity = '1';
                panel.style.transform = 'translateY(0)';
            }, 10);
        }

        function zoomToLocation(location) {
            const coords = projection([location.coordinates.longitude, location.coordinates.latitude]);
            const scale = 3;
            const translate = [mapWidth / 2 - scale * coords[0], mapHeight / 2 - scale * coords[1]];
            mapSvg.transition().duration(750)
                .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }

        function zoomed(event) {
            g.attr("transform", event.transform);
            currentTransform = event.transform;
        }

        function zoomIn() { mapSvg.transition().duration(300).call(zoom.scaleBy, 1.5); }
        function zoomOut() { mapSvg.transition().duration(300).call(zoom.scaleBy, 1 / 1.5); }
        function resetView() { 
            mapSvg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
            
            // Reset all visual states
            g.selectAll(".historical-location").classed("active", false).style("opacity", 0.7);
            g.selectAll(".historical-ring").classed("active", false).style("opacity", 0);
            g.selectAll(".historical-label").classed("active", false).style("opacity", 0);
            italySvg.selectAll(".italy-location").classed("active", false).classed("inactive", true);
            timelineSvg.selectAll(".timeline-event").classed("active", false).classed("inactive", false);
            
            // Hide paths if visible
            if (pathsVisible) {
                showManuscriptPaths(); // This will toggle them off
            }
            
            document.getElementById('info-panel').style.display = 'none';
            activeLocationIndex = -1;
        }

        // Enhanced mouse interactions
        function addInteractiveFeatures() {
            // Add hover effects to locations
            g.selectAll(".historical-location")
                .on("mouseenter", function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", 8)
                        .style("filter", "drop-shadow(0 0 10px currentColor)");
                        
                    // Show preview tooltip
                    const tooltip = d3.select("body").append("div")
                        .attr("id", "preview-tooltip")
                        .style("position", "absolute")
                        .style("background", "rgba(0, 0, 0, 0.85)")
                        .style("color", "white")
                        .style("padding", "8px 12px")
                        .style("border-radius", "6px")
                        .style("font-size", "11px")
                        .style("pointer-events", "none")
                        .style("z-index", "10001")
                        .style("opacity", "0")
                        .html(`<strong>${d.location}</strong><br/>${d.time}<br/>Click for details`)
                        .style("left", (event.pageX + 15) + "px")
                        .style("top", (event.pageY - 40) + "px");
                    
                    tooltip.transition().duration(200).style("opacity", "1");
                })
                .on("mouseleave", function(event, d) {
                    d3.select(this)
                        .transition()
                        .duration(200)
                        .attr("r", 6)
                        .style("filter", "none");
                        
                    d3.select("#preview-tooltip").remove();
                });

            // Add manuscript legend tooltips
            addManuscriptLegendTooltips();
        }

        function addManuscriptLegendTooltips() {
            const manuscriptDetails = {
                "ptolemy_geography": {
                    title: "Ptolemy's Geography",
                    period: "c. 150 CE",
                    origin: "Alexandria, Egypt",
                    description: "A comprehensive treatise on cartography and geography by Claudius Ptolemy. This foundational work influenced mapmaking for over a millennium and was translated into Latin in 1406 by Jacobus Angelus.",
                    significance: "One of the most influential geographical works in history, combining mathematical precision with ancient knowledge of the world."
                },
                "vergilius_vaticanus": {
                    title: "Vergilius Vaticanus",
                    period: "c. 400 CE",
                    origin: "Rome, Italy",
                    description: "An illuminated manuscript containing works by Virgil, created for a wealthy Roman aristocrat. Features exquisite miniatures and is one of the oldest surviving illustrated manuscripts of classical literature.",
                    significance: "A masterpiece of late antique book illumination, representing the pinnacle of Roman artistic achievement in manuscript production."
                },
                "federico_bible_volume_1": {
                    title: "Federico's Bible Volume 1",
                    period: "1460-1476 CE",
                    origin: "Urbino, Italy",
                    description: "The first volume of a magnificent two-volume Bible commissioned by Federico da Montefeltro, Duke of Urbino. Created by the finest scribes and illuminators of the Renaissance.",
                    significance: "Represents the height of Renaissance manuscript illumination, combining classical learning with Christian devotion in a princely context."
                },
                "federico_bible_volume_2": {
                    title: "Federico's Bible Volume 2",
                    period: "1476-1478 CE",
                    origin: "Florence, Italy",
                    description: "The second volume of Federico's Bible, created in Florence under the direction of Vespasiano da Bisticci. Completed during the tumultuous Pazzi War period.",
                    significance: "Demonstrates the international nature of Renaissance manuscript production and the political challenges of the era."
                },
                "mixtec_codex_vat_lat_3773": {
                    title: "Mixtec Codex",
                    period: "c. 1350-1500 CE",
                    origin: "Puebla region, Mexico",
                    description: "A pre-Columbian manuscript from the Mixtec civilization, featuring pictographic writing and religious iconography. Acquired by the Vatican during the colonial period.",
                    significance: "Represents the rich cultural heritage of Mesoamerican civilizations and the complex process of cultural exchange during European colonization."
                }
            };

            document.querySelectorAll('.legend-item').forEach(item => {
                const manuscriptId = item.getAttribute('data-manuscript');
                const details = manuscriptDetails[manuscriptId];
                
                if (details) {
                    item.addEventListener('mouseenter', function(event) {
                        // Highlight the legend item
                        this.style.backgroundColor = 'rgba(0, 0, 0, 0.1)';
                        
                        // Create detailed tooltip
                        const tooltip = document.createElement('div');
                        tooltip.id = 'manuscript-tooltip';
                        tooltip.style.cssText = `
                            position: absolute;
                            background: rgba(0, 0, 0, 0.95);
                            color: white;
                            padding: 15px;
                            border-radius: 8px;
                            font-size: 12px;
                            max-width: 300px;
                            pointer-events: none;
                            z-index: 10002;
                            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
                            border: 1px solid rgba(255, 255, 255, 0.2);
                        `;
                        
                        tooltip.innerHTML = `
                            <div style="font-weight: bold; font-size: 14px; margin-bottom: 8px; color: ${manuscriptMetadata[manuscriptId]?.color || '#fff'};">${details.title}</div>
                            <div style="margin-bottom: 6px;"><strong>Period:</strong> ${details.period}</div>
                            <div style="margin-bottom: 6px;"><strong>Origin:</strong> ${details.origin}</div>
                            <div style="margin-bottom: 8px; line-height: 1.4;">${details.description}</div>
                            <div style="font-style: italic; color: #e0e0e0; line-height: 1.3;">${details.significance}</div>
                        `;
                        
                        document.body.appendChild(tooltip);
                        
                        // Position tooltip
                        const rect = this.getBoundingClientRect();
                        const tooltipRect = tooltip.getBoundingClientRect();
                        const x = rect.left - tooltipRect.width - 10;
                        const y = rect.top + (rect.height - tooltipRect.height) / 2;
                        
                        tooltip.style.left = Math.max(10, x) + 'px';
                        tooltip.style.top = Math.max(10, y) + 'px';
                        
                        // Fade in
                        tooltip.style.opacity = '0';
                        setTimeout(() => {
                            tooltip.style.transition = 'opacity 0.2s ease';
                            tooltip.style.opacity = '1';
                        }, 10);
                    });
                    
                    item.addEventListener('mouseleave', function(event) {
                        // Remove highlight
                        this.style.backgroundColor = 'transparent';
                        
                        // Remove tooltip
                        const tooltip = document.getElementById('manuscript-tooltip');
                        if (tooltip) {
                            tooltip.style.transition = 'opacity 0.2s ease';
                            tooltip.style.opacity = '0';
                            setTimeout(() => tooltip.remove(), 2);
                        }
                    });
                }
            });
        }

        async function loadAllData() {
            try {
                const [manuscriptsRes, metadataRes, italyLocsRes] = await Promise.all([
                    fetch('data/comprehensive_manuscripts.json'),
                    fetch('data/manuscript_metadata.json'),
                    fetch('data/italian_locations.json')
                ]);
                if (!manuscriptsRes.ok || !metadataRes.ok || !italyLocsRes.ok) throw new Error('Failed to fetch one or more data files');
                comprehensiveManuscriptData = await manuscriptsRes.json();
                manuscriptMetadata = await metadataRes.json();
                window.italianLocations = await italyLocsRes.json();
            } catch (e) {
                console.error('Error loading local JSON data:', e);
                throw e;
            }
        }

        async function bootstrap() {
            try {
                await loadAllData();
                await loadWorldData();
            } catch (e) {
                document.getElementById('loading').innerHTML = '<div style="color: #e74c3c;"><strong>Error loading app data</strong></div>';
            }
        }

        // Start loading
        bootstrap();
    </script>
</body>
</html>